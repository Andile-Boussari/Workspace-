<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire de validation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">    
  <style>
    body {
      background-color: #f8f9fa;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: Arial, sans-serif;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 600px;
    }

    .container img {
      width: 80px;
      display: block;
      margin: 0 auto 15px;
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-check-label, label {
      font-size: 1rem;
    }

    .form-control {
      width: 100%;
      max-width: 100%;
      padding: 10px;
      margin: 5px 0;
    }

    .form-select {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
    }

    .btn {
      width: 100%;
      padding: 12px;
      font-size: 1.1rem;
    }

    .tableau-container {
      margin-top: 30px;
      display: none;
    }

    .tableau-resume td:nth-child(2),
    .tableau-resume td:nth-child(3) {
      text-align: center;
    }

    .tableau-resume tr:nth-child(1) { background-color: #d3d3d3; }
    .tableau-resume tr:nth-child(2) { background-color: #90ee90; }
    .tableau-resume tr:nth-child(3) { background-color: #ffd700; }
    .tableau-resume tr:nth-child(4) { background-color: #ffcccb; }

    .required-star {
      color: red;
      margin-left: 4px;
    }

    td .info-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Pour rendre les placeholder en italique */
   .italic-placeholder::placeholder {
   font-style: italic;
   color: #6c757d; /* gris clair Bootstrap */
  }

  .tooltip-inner {
    max-width: 600px !important;  /* Largeur personnalis√©e */
    white-space: normal;          /* Autorise les retours √† la ligne */
    text-align: left;
    font-size: 0.9rem;
    background-color: #fff !important;  /* Fond blanc */
    color: #212529;              /* Couleur de texte Bootstrap */
    border: 1px solid #ccc;      /* Petite bordure grise */
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1); /* L√©g√®re ombre */
  }


  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<body>
  <div id="messageFormulaire" class="alert text-center" style="display:none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 600px;"></div>
  <div class="container">
    <img src="https://storage.googleapis.com/endurance-apps-liip/media/cache/no_filter_grid_fs/5d27428812574a08a67ab0d3" alt="Logo">
    <h2>Formulaire de validation</h2>
    <p class="text-muted text-center fst-italic" style="font-size: 0.9rem;">
      <span class="required-star">*</span> Indique un champs obligatoires
    </p>


    <div class="form-group">
      <label for="email">üìß E-mail :<span class="required-star">*</span></label>
      <!-- <input type="email" id="email" class="form-control" placeholder="Veuillez entrez votre adresse e-mail"> -->
      <input type="email" id="email" class="form-control" placeholder="Veuillez entrer votre adresse e-mail" style="font-style: italic;">
    </div>

    <!--<div class="form-group">
      <label for="codeCassini">üîç Code CASSINI :</label>
      <input type="text" id="codeCassini" class="form-control" placeholder="Ex : A1790"  oninput="filtrerApplications()">
    </div>-->
    <div class="form-group">
      <label for="codeCassini" class="d-block">
        üîç Code CASSINI :
        <span class="text-muted fst-italic" style="font-size: 0.9rem; display: block;">
        Veuillez entrer un code CASSINI pour filtrer la liste des applications.
        </span>
      </label>
       <input type="text" id="codeCassini" class="form-control" placeholder="Ex : A1790 :" oninput="filtrerApplications()">
    </div>



    <div class="form-group">
      <label for="application">üìã Application m√©tier:<span class="required-star">*</span></label>
        </span>
      <select id="application" class="form-select" onchange="mettreAJourCodeCassini()"></select>
    </div>

   <div class="form-group">
  <label class="form-label">‚úÖ Type de Validation:<span class="required-star">*</span></label>
  <p class="text-muted fst-italic mb-1" style="font-size: 0.9rem;">Veuillez indiquer le type de validation</p>

  <div class="form-check">
    <input type="radio" id="technique" name="validation" value="Technique" class="form-check-input" onchange="toggleTableau()">
    <label for="technique" class="form-check-label">Technique</label>
  </div>
  <div class="form-check">
    <input type="radio" id="fonctionnel" name="validation" value="Fonctionnel" class="form-check-input" onchange="toggleTableau()">
    <label for="fonctionnel" class="form-check-label">Fonctionnel</label>
  </div>
</div>


    <div class="form-group">
      <label for="niveauValidation">Niveau de validation:<span class="required-star">*</span> </label>
      <select id="niveauValidation" class="form-select">
        <!-- <option value="">Veuillez indiquez le niveau de validation </option> -->
        <option value="" disabled selected style="font-style: italic; color: #6c757d;">Veuillez indiquer le niveau de validation</option>
        <option value="Valid√© avec r√©serve">Valid√© avec r√©serve</option>
        <option value="Valid√© sans r√©serve">Valid√© sans r√©serve</option>
        <option value="Non valide">Non valide</option>
        <option value="Pas de Validation Technique Possible">Pas de Validation Technique Possible</option>
        <option value="Pas de Validation Fonctionnelle Possible">Pas de Validation Fonctionnelle Possible</option>
      </select>
    </div>

    <div class="form-group">
       <label for="tempsPasse">‚è± Temps pass√©:<span class="required-star">*</span></label>
       <span class="text-muted fst-italic d-block mb-1" style="font-size: 0.9rem;">
       Veuillez indiquer le temps pass√© en minutes.
       </span>
       <input type="number" min="5" id="tempsPasse" class="form-control" placeholder="5" />
    </div>


    <div class="form-group">
     <label for="commentaires">üí¨ Commentaires :</label>
     <textarea id="commentaires" class="form-control italic-placeholder" rows="1" placeholder="Veuillez indiquer les commentaires √©ventuels."></textarea>
    </div>


    
    <div class="tableau-container mt-4 p-3 border rounded bg-light" id="tableauContainer">
      <label class="form-label">üìë R√©sum√© des cas de tests fonctionnels:<span class="required-star">*</span></label>
      <p class="text-muted fst-italic mt-2" style="font-size: 0.9rem;">
  üõà Merci de respecter l‚Äôordre de saisie : commencez par <strong>Nb de cas PREVUS</strong> puis <strong>EXECUT√âS</strong> avant de renseigner les autres champs.
</p>

      <table class="table table-bordered table-sm align-middle text-center">
    <tbody>
      <tr class="table-secondary">
        <td class="text-start">Nb de cas PREVUS / EXECUTE</td>
        <td>
          <input type="number" id="nbCasPrevus" min="0" class="form-control form-control-sm text-center" value="0" oninput="verifierCoh√©rence(); appliquerOrdreRemplissage();" >
        </td>
        <td>
          <input type="number" id="nbCasExecutes" min="0"class="form-control form-control-sm text-center" value="0" oninput="verifierCoh√©rence(); appliquerOrdreRemplissage();">
        </td>
      </tr>
      <tr class="table-success">
        <td class="text-start">Nb de cas VALIDES</td>
        <td colspan="2">
          <input type="number" id="nbCasValides" min="0" class="form-control form-control-sm text-center" value="0" oninput="verifierCoh√©rence()">
        </td>
      </tr>
      <tr class="table-warning">
        <td class="text-start">Nb VALIDES AVEC RESERVES</td>
        <td colspan="2">
          <input type="number" id="nbCasValidesAvecReserves" min="0" class="form-control form-control-sm text-center" value="0" oninput="verifierCoh√©rence()">
        </td>
      </tr>
      <tr class="table-danger">
        <td class="text-start">Nb NON VALIDES</td>
        <td colspan="2">
          <input type="number" id="nbCasNonValides" min="0" class="form-control form-control-sm text-center" value="0" oninput="verifierCoh√©rence()">
        </td>
      </tr>

<tr class="table-info">
  <td class="text-start">
    <span class="info-label">
      <span 
        id="tooltipCoherence"
        data-bs-toggle="tooltip"
        data-bs-placement="right"
        style="cursor: help; color: #0d6efd;">
        ‚ÑπÔ∏è
      </span>
      Contr√¥le de coh√©rence
    </span>
  </td>
  <td colspan="2">
    <input type="text" id="controleCoh√©rence" class="form-control form-control-sm text-center fw-bold" readonly>
  </td>
</tr>



</tr>
    </tbody>
  </table>
</div>

    <div id="messageFormulaire" class="mt-3 text-center"></div>
    <!-- <button class="btn btn-primary mt-3" onclick="envoyerFormulaire()">üöÄ Envoyer</button> -->
    <button id="btnEnvoyer" class="btn btn-primary mt-3" onclick="envoyerFormulaire()">üöÄ Envoyer</button>

  </div>

  <script>
    let applications = [];

    function chargerApplications() {
      google.script.run.withSuccessHandler(function(data) {
        applications = data;
        afficherApplications();
      }).getApplications();
    }

    function afficherApplications() {
      const dropdown = document.getElementById("application");
      dropdown.innerHTML = '<option value="" disabled selected style="font-style: italic; color: #6c757d;">Veuillez s√©lectionner une application</option>';
      applications.forEach(app => {
        const option = document.createElement("option");
        option.value = `${app.code} - ${app.nom}`;
        option.textContent = `${app.code} - ${app.nom}`;
        dropdown.appendChild(option);
      });
    }

    function filtrerApplications() {
      const codeCassini = document.getElementById("codeCassini").value.toUpperCase().trim();
      const dropdown = document.getElementById("application");
      dropdown.innerHTML = '<option value="">Veuillez s√©lectionner une application </option>';

      const filtres = applications.filter(app => app.code.toUpperCase().includes(codeCassini));
      (filtres.length ? filtres : applications).forEach(app => {
        const option = document.createElement("option");
        option.value = `${app.code} - ${app.nom}`;
        option.textContent = `${app.code} - ${app.nom}`;
        dropdown.appendChild(option);
      });
    }

    function mettreAJourCodeCassini() {
      const val = document.getElementById("application").value;
      if (val.includes(" - ")) {
        document.getElementById("codeCassini").value = val.split(" - ")[0];
      }
    }

   function toggleTableau() {
  const type = document.querySelector('input[name="validation"]:checked')?.value;
  const tableau = document.getElementById("tableauContainer");

  if (type === "Fonctionnel") {
    tableau.style.display = "block";
  } else {
    tableau.style.display = "none";
    reinitialiserTableauFonctionnel(); // ‚¨ÖÔ∏è R√©initialise quand on passe en Technique
  }
}

function verifierCoh√©rence() {
  const nbPrevus = parseInt(document.getElementById("nbCasPrevus").value) || 0;
  const nbExecutes = parseInt(document.getElementById("nbCasExecutes").value) || 0;
  const nbValides = parseInt(document.getElementById("nbCasValides").value) || 0;
  const nbValidesReserves = parseInt(document.getElementById("nbCasValidesAvecReserves").value) || 0;
  const nbNonValides = parseInt(document.getElementById("nbCasNonValides").value) || 0;

  const totalCalcul√© = nbValides + nbValidesReserves + nbNonValides;
  const controle = document.getElementById("controleCoh√©rence");
  const ligneControle = controle.closest("tr");
  const bouton = document.getElementById("btnEnvoyer");

  // üö´ Si Ex√©cut√©s > Pr√©vus ‚Üí Non coh√©rent
  if (nbExecutes > nbPrevus) {
    controle.value = "‚ùå Non coh√©rent";
    ligneControle.className = "table-danger";
    bouton.disabled = true;
    return;
  }

  // ‚ö†Ô∏è Somme incoh√©rente
  if (nbExecutes !== totalCalcul√©) {
    controle.value = "‚ö†Ô∏è Somme incoh√©rente";
    ligneControle.className = "table-danger";
    bouton.disabled = true;
    return;
  }

  //‚úÖ Coh√©rent - majorit√© de cas valides
  if ((nbValides + nbValidesReserves) > nbNonValides) {
    controle.value = "‚úÖ Coh√©rent";
    ligneControle.className = "table-success";
    bouton.disabled = false;
    return;
  }

  // ‚úÖ Coh√©rent - majorit√© de non valides
  if ((nbValides + nbValidesReserves) < nbNonValides) {
    controle.value = "‚úÖ Coh√©rent";  
    ligneControle.className = "table-danger";
    bouton.disabled = false;
    return;
  }

  // ‚úÖ Coh√©rent - √©galit√©
  controle.value = "‚úÖ Coh√©rent";
  ligneControle.className = "table-info";
  bouton.disabled = false;
}


 <!-- Version modifi√©e avec r√®gles de gestion PV_TYPE, ZLS_VALIDATION2, ZLS_VALIDATION3 -->
<!-- Partie modifi√©e uniquement dans le script JS -->

function envoyerFormulaire() {
  let email = document.getElementById("email").value;
  let codeCassini = document.getElementById("codeCassini").value;
  let application = document.getElementById("application").value;
  let validation = document.querySelector('input[name="validation"]:checked')?.value;
  let niveauValidation = document.getElementById("niveauValidation").value;
  let tempsPasse = document.getElementById("tempsPasse").value;
  let commentaires = document.getElementById("commentaires").value;

  let nbCasPrevus = document.getElementById("nbCasPrevus")?.value || "";
  let nbCasExecutes = document.getElementById("nbCasExecutes")?.value || "";
  let nbCasValides = document.getElementById("nbCasValides")?.value || "";
  let nbCasValidesAvecReserves = document.getElementById("nbCasValidesAvecReserves")?.value || "";
  let nbCasNonValides = document.getElementById("nbCasNonValides")?.value || "";
  let controleCoh√©rence = document.getElementById("controleCoh√©rence")?.value || "";

  if (!email || !codeCassini || !application || !validation || !niveauValidation || !tempsPasse) {
    afficherMessage("‚ùå Veuillez remplir tous les champs obligatoires.", "danger");
    return;
  }

  // ‚úÖ R√®gle de gestion PV_TYPE
  let pvType = "";
  if (validation === "Technique") {
    pvType = "1_PV_TECH";
  } else if (validation === "Fonctionnel") {
    pvType = "2_PV_FONC";
  }

  // ‚úÖ R√®gle de gestion ZLS_VALIDATION2 et ZLS_VALIDATION3
  let zls2 = "", zls3 = "";
  switch (niveauValidation) {
    case "Valid√© sans r√©serve":
      zls2 = "OK";
      zls3 = "OK";
      break;
    case "Valid√© avec r√©serve":
      zls2 = "OK_RESERVE";
      zls3 = "OK";
      break;
    case "Non valide":
      zls2 = "NOK";
      zls3 = "NOK";
      break;
    case "Pas de Validation Technique Possible":
      zls2 = "PTTP";
      zls3 = "AUTRE";
      break;
    case "Pas de Validation Fonctionnelle Possible":
      zls2 = "PTFP";
      zls3 = "AUTRE";
      break;
  }

  google.script.run.withSuccessHandler(function(response) {
    afficherMessage(response, "success");
    reinitialiserFormulaire();
  }).validerFormulaire({
    email,
    codeCassini,
    application,
    validation,
    niveauValidation,
    tempsPasse,
    commentaires,
    pvType,
    zls2,
    zls3,
    nbCasPrevus,
    nbCasExecutes,
    nbCasValides,
    nbCasValidesAvecReserves,
    nbCasNonValides,
    controleCoh√©rence
  });
}



document.getElementById("niveauValidation").addEventListener("change", function() {
  const selectedValue = this.value;

  if (selectedValue === "Pas de Validation Technique Possible") {
    document.getElementById("technique").checked = true;
    toggleTableau();
    activerDesactiverTableauFonctionnel(true);
  } else if (selectedValue === "Pas de Validation Fonctionnelle Possible") {
    document.getElementById("fonctionnel").checked = true;
    toggleTableau();
    activerDesactiverTableauFonctionnel(false);
  } else {
    activerDesactiverTableauFonctionnel(true);
  }

  // üëá Appelle notre fonction ici
  appliquerContraintesNiveauValidation();
});





function afficherMessage(message, type) {
  const messageDiv = document.getElementById("messageFormulaire");
  messageDiv.className = `alert alert-${type} text-center`;
  messageDiv.innerHTML = message;
  messageDiv.style.display = "block";

  // ‚è≥ On augmente la dur√©e √† 12 secondes
  setTimeout(() => {
    messageDiv.style.display = "none";
  }, 12000);
}

function reinitialiserFormulaire() {
  // R√©initialise tous les champs manuellement
  document.getElementById("email").value = "";
  document.getElementById("codeCassini").value = "";
  document.getElementById("application").selectedIndex = 0;
  document.querySelectorAll('input[name="validation"]').forEach(el => el.checked = false);
  document.getElementById("niveauValidation").selectedIndex = 0;
  document.getElementById("tempsPasse").value = "";
  document.getElementById("commentaires").value = "";

  // Champs des cas de test fonctionnels
  document.getElementById("nbCasPrevus").value = "0";
  document.getElementById("nbCasExecutes").value = "0";
  document.getElementById("nbCasValides").value = "0";
  document.getElementById("nbCasValidesAvecReserves").value = "0";
  document.getElementById("nbCasNonValides").value = "0";
  document.getElementById("controleCoh√©rence").value = "0";

  // Masquer le tableau si besoin
  document.getElementById("tableauContainer").style.display = "none";
}

function reinitialiserTableauFonctionnel() {
  document.getElementById("nbCasPrevus").value = "0";
  document.getElementById("nbCasExecutes").value = "0";
  document.getElementById("nbCasValides").value = "0";
  document.getElementById("nbCasValidesAvecReserves").value = "0";
  document.getElementById("nbCasNonValides").value = "0";
  document.getElementById("controleCoh√©rence").value = "";
  
  const ligneControle = document.getElementById("controleCoh√©rence").closest("tr");
  ligneControle.className = "table-info";
  document.getElementById("btnEnvoyer").disabled = false;
}

function activerDesactiverTableauFonctionnel(etat) {
  const champs = [
    "nbCasPrevus",
    "nbCasExecutes",
    "nbCasValides",
    "nbCasValidesAvecReserves",
    "nbCasNonValides",
    "controleCoh√©rence"
  ];

  champs.forEach(id => {
    const champ = document.getElementById(id);
    champ.disabled = !etat; // D√©sactive si √©tat = false
    champ.style.backgroundColor = etat ? "" : "#f0f0f0"; // gris clair si d√©sactiv√©
  });
}


function appliquerContraintesNiveauValidation() {
  const niveau = document.getElementById("niveauValidation").value;

  const valides = document.getElementById("nbCasValides");
  const reserves = document.getElementById("nbCasValidesAvecReserves");
  const nonValides = document.getElementById("nbCasNonValides");

  // Reset (r√©active tous les champs au d√©part)
  [valides, reserves, nonValides].forEach(champ => {
    champ.disabled = false;
    champ.style.backgroundColor = ""; // reset couleur
  });

  if (niveau === "Non valide") {
    // Glisse les cas valides + avec r√©serves
    [valides, reserves].forEach(champ => {
      champ.value = "";
      champ.disabled = true;
      champ.style.backgroundColor = "#f0f0f0";
    });
  }

  if (niveau === "Valid√© sans r√©serve" || niveau === "Valid√© avec r√©serve") {
    // Glisse les cas non valides
    nonValides.value = "";
    nonValides.disabled = true;
    nonValides.style.backgroundColor = "#f0f0f0";
  }

  if (niveau === "Pas de Validation Fonctionnelle Possible") {
  document.getElementById("fonctionnel").checked = true;
  toggleTableau();
  activerDesactiverTableauFonctionnel(false);

  // ‚¨áÔ∏è Glisse aussi les champs fonctionnels manuellement
  ["nbCasValides", "nbCasValidesAvecReserves", "nbCasNonValides"].forEach(id => {
    const champ = document.getElementById(id);
    champ.value = "";
    champ.disabled = true;
    champ.style.backgroundColor = "#f0f0f0";
  });

  return; // ‚úÖ On sort pour √©viter que les autres blocs ne les r√©activent
}


  // Mise √† jour du contr√¥le en direct
  verifierCoh√©rence();
}

function appliquerOrdreRemplissage() {
  const prevus = parseInt(document.getElementById("nbCasPrevus").value) || 0;
  const executes = parseInt(document.getElementById("nbCasExecutes").value) || 0;

  const champExecutes = document.getElementById("nbCasExecutes");
  const champsAutres = [
    document.getElementById("nbCasValides"),
    document.getElementById("nbCasValidesAvecReserves"),
    document.getElementById("nbCasNonValides")
  ];

  // √âtape 1 : tant que PREVUS vide ‚Üí tout est d√©sactiv√© sauf lui
  if (prevus === 0) {
    champExecutes.disabled = true;
    champsAutres.forEach(c => c.disabled = true);
    return;
  }

  // √âtape 2 : PREVUS rempli ‚Üí EXECUTES actif, les autres encore bloqu√©s
  champExecutes.disabled = false;

  if (executes === 0) {
    champsAutres.forEach(c => c.disabled = true);
    return;
  }

  // √âtape 3 : PREVUS + EXECUTES remplis ‚Üí les autres deviennent actifs
  champsAutres.forEach(c => c.disabled = false);
}



 window.onload = function () {
  chargerApplications();

  // ‚úÖ Cr√©e manuellement le tooltip HTML
  const tooltipCoherence = document.getElementById("tooltipCoherence");
  const htmlContent = `
    ‚úÖ <strong>Coh√©rent</strong> : Nb VALIDES + AVEC RESERVES + NON VALIDES = Nb EXECUTES<br>
    ‚ùå <strong>Non Coh√©rent</strong> : Nb EXECUTES &gt; Nb PREVUS<br>
    ‚ö†Ô∏è <strong>Somme incoh√©rente</strong> : Somme ‚â† Nb EXECUTES
  `;

  const tooltip = new bootstrap.Tooltip(tooltipCoherence, {
    title: htmlContent,
    html: true,
    placement: 'right',
    trigger: 'hover focus'
  });
};



  </script>
</body>
</html>
